function setFood(){for(var a=[],b=0;b<grid.width;b++)for(var c=0;c<grid.height;c++)grid.get(b,c)===EMPTY&&a.push({x:b,y:c});var d=a[Math.floor(Math.random()*a.length)];grid.set(FRUIT,d.x,d.y),ctx.fillStyle="#F00",ctx.fillRect(d.x*tw,d.y*th,tw,th)}function main(){canvas=document.getElementById("snakeCanvas"),canvas.width=20*COLS,canvas.height=20*ROWS,ctx=canvas.getContext("2d"),frames=0,keystates={},document.addEventListener("keydown",function(a){keystates[a.keyCode]=!0}),document.addEventListener("keyup",function(a){delete keystates[a.keyCode]}),init(),loop()}function init(){grid.init(EMPTY,COLS,ROWS);var a={x:Math.floor(COLS/2),y:ROWS-5};snake.init(UP,a.x,a.y),grid.set(SNAKE,a.x,a.y),grid.set(SNAKE,a.x,a.y+1),grid.set(SNAKE,a.x,a.y+2),setFood(),score=0}function loop(){reqID=window.requestAnimationFrame(loop,canvas),update()}function gameOver(){window.cancelAnimationFrame(reqID),console.log("gameOver")}function update(){if(frames++,_changeDirection(),frames%4===0){var a=snake.head.x,b=snake.head.y;switch(snake.direction){case LEFT:a--;break;case UP:b--;break;case RIGHT:a++;break;case DOWN:b++}0>a?a=grid.width-1:a>grid.width-1?a=0:0>b?b=grid.height-1:b>grid.height-1&&(b=0),grid.get(a,b)===SNAKE&&gameOver();var c={x:a,y:b};grid.get(a,b)===FRUIT?(score++,setFood()):(tail=snake.remove(),grid.set(EMPTY,tail.x,tail.y)),grid.set(SNAKE,c.x,c.y),snake.insert(c.x,c.y)}}function draw(){for(var a=canvas.width/grid.width,b=canvas.height/grid.height,c=0;c<grid.width;c++)for(var d=0;d<grid.height;d++){switch(grid.get(c,d)){case EMPTY:ctx.fillStyle="#FFF";break;case SNAKE:ctx.fillStyle="#0FF";break;case FRUIT:ctx.fillStyle="#F00"}ctx.fillRect(c*a,d*b,a,b)}ctx.fillStyle="#000",ctx.fillText("SCORE: "+score,10,canvas.height-10)}function _changeDirection(){keystates[KEY_LEFT]&&snake.direction!==RIGHT&&(snake.direction=LEFT),keystates[KEY_UP]&&snake.direction!==DOWN&&(snake.direction=UP),keystates[KEY_RIGHT]&&snake.direction!==LEFT&&(snake.direction=RIGHT),keystates[KEY_DOWN]&&snake.direction!==UP&&(snake.direction=DOWN)}window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a,b){return window.setTimeout(a,1e3/60)}}(),window.cancelRequestAnimFrame=function(){return window.cancelAnimationFrame||window.webkitCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.msCancelRequestAnimationFrame||clearTimeout}();var reqID,canvas,ctx,keystates,frames,score,tw,th,ROWS=30,COLS=30,EMPTY=0,SNAKE=1,FRUIT=2,LEFT=0,UP=1,RIGHT=2,DOWN=3,KEY_LEFT=37,KEY_UP=38,KEY_RIGHT=39,KEY_DOWN=40,grid={width:null,height:null,_grid:null,init:function(a,b,c){this.width=b,this.height=c,this._grid=[],tw=canvas.width/grid.width,th=canvas.height/grid.height;for(var d=0;b>d;d++){this._grid.push([]);for(var e=0;c>e;e++)this._grid[d].push(a)}},set:function(a,b,c){this._grid[b][c]=a},get:function(a,b){return this._grid[a][b]}},snake={direction:null,head:null,_queue:null,init:function(a,b,c){this.direction=a,this._queue=[],this.insert(b,c+2),this.insert(b,c+1),this.insert(b,c)},insert:function(a,b){this._queue.unshift({x:a,y:b}),this.head=this._queue[0],ctx.fillStyle="#0FF",ctx.fillRect(a*tw,b*th,tw,th)},remove:function(a){var b=this._queue.pop();return ctx.clearRect(b.x*tw,b.y*th,tw,th),b}};main();